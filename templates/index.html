<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Predicci√≥n de Casos de Dengue</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <h1>Predicci√≥n de Casos de Dengue en el departamento de Caquet√°</h1>

  <div class="contenedor">
    <!-- Columna izquierda: formulario -->
    <div class="col-izquierda">
      <form id="formulario">
        <!-- 1. Municipio -->
        <label for="municipio">Municipio:</label>
        <select id="municipio" name="municipio" required>
          <option value="">Seleccione un municipio</option>
          <option value="CAQUET√Å">Todos los municipios</option>
          <option value="FLORENCIA">Florencia</option>
          <option value="SAN VICENTE DEL CAGUAN">San Vicente del Cagu√°n</option>
          <option value="CARTAGENA DELCHAIRA">Cartagena del Chair√°</option>
          <option value="EL PAUJIL">El Paujil</option>
          <option value="SOLANO">Solano</option>
          <option value="CURILLO">Curillo</option>
          <option value="PUERTO RICO">Puerto Rico</option>
          <option value="SAN JOSE DEL FRAGUA">San Jos√© del Fragua</option>
          <option value="MORELIA">Morelia</option>
          <option value="SOLITA">Solita</option>
          <option value="BELEN DE LOS ANDAQUIES">Bel√©n de los Andaqu√≠es</option>
          <option value="LA MONTANITA">La Monta√±ita</option>
          <option value="EL DONCELLO">El Doncello</option>
          <option value="ALBANIA">Albania</option>
          <option value="VALPARAISO">Valpara√≠so</option>
          <option value="MILAN">Mil√°n</option>
        </select>

        <!-- 2. Mes -->
        <label for="Mes_Num">Mes:</label>
        <select id="Mes_Num" name="Mes_Num" required>
          <option value="">Seleccione un mes</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>

        <!-- 3. Lluvias -->
        <label for="Lluvia_mm_lag1">Lluvia del mes anterior (mm):</label>
        <input type="number" id="Lluvia_mm_lag1" name="Lluvia_mm_lag1" step="0.1" required />

        <!-- 4. Temperatura -->
        <label for="Temperatura_lag1">Temperatura del mes anterior (¬∞C):</label>
        <input type="number" id="Temperatura_lag1" name="Temperatura_lag1" step="0.1" required />

        <button type="submit">Predecir</button>
      </form>

      <div id="resultado"></div>
    </div>

  <!-- Columna derecha: imagen din√°mica del municipio -->
  <aside class="col-derecha panel-imagen">
    <h2>Seleccione un municipio</h2>
    <img
      id="mapaMunicipio"
      src="{{ url_for('static', filename='img/default.png') }}"
      alt="Mapa del municipio seleccionado"
    />
    <p id="municipioLabel" class="municipio-label">üü© Municipio seleccionado</p>
  </aside>
</div>


  <div id="resultado"></div>

  <script>
    // Poblaciones por municipio
    const poblaciones = {
      "ALBANIA": 6432, "BELEN DE LOS ANDAQUIES": 11601, "CARTAGENA DELCHAIRA": 33908,
      "CURILLO": 11737, "EL DONCELLO": 22183, "EL PAUJIL": 20528, "FLORENCIA": 175395,
      "LA MONTANITA": 23789, "MILAN": 11774, "MORELIA": 3836, "PUERTO RICO": 33447,
      "SAN JOSE DEL FRAGUA": 15029, "SAN VICENTE DEL CAGUAN": 69214, "SOLANO": 24131,
      "SOLITA": 9143, "VALPARAISO": 11687, "CAQUET√Å": 0 
    };

    // Diccionario de meses
    const meses = {
      1: "Enero", 2: "Febrero", 3: "Marzo", 4: "Abril", 5: "Mayo", 6: "Junio",
      7: "Julio", 8: "Agosto", 9: "Septiembre", 10: "Octubre", 11: "Noviembre", 12: "Diciembre"
    };

    document.getElementById("formulario").addEventListener("submit", async (e) => {
      e.preventDefault();

      const municipio = document.getElementById("municipio").value;
      const mesNum = parseInt(document.getElementById("Mes_Num").value, 10);

      if (!municipio || !(municipio in poblaciones)) {
        document.getElementById("resultado").innerHTML =
          `<span style="color:red;">Debe seleccionar un municipio v√°lido</span>`;
        return;
      }

      if (!mesNum || !(mesNum in meses)) {
        document.getElementById("resultado").innerHTML =
          `<span style="color:red;">Debe seleccionar un mes v√°lido</span>`;
        return;
      }

      const datos = {
        Lluvia_mm_lag1: parseFloat(document.getElementById("Lluvia_mm_lag1").value),
        Temperatura_lag1: parseFloat(document.getElementById("Temperatura_lag1").value),
        Poblacion: poblaciones[municipio],
        Mes_Num: mesNum
      };

      try {
        const resp = await fetch("/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });
        const result = await resp.json();

        const pred =
          result.prediccion_casos_dengue ??
          result.prediccion ??
          result["Prediccion de casos dedengue"];

        if (result.error) {
          document.getElementById("resultado").innerHTML =
            `<span style="color:red;">Error: ${result.error}</span>`;
        } else {
          document.getElementById("resultado").innerHTML =
            `‚úÖ Municipio: <b>${municipio}</b><br>
             üìä Mes: <b>${meses[mesNum]}</b><br>
             üîÆ Predicci√≥n de casos de dengue: <b>${pred}</b>`;
        }
      } catch (err) {
        document.getElementById("resultado").innerHTML =
          `<span style="color:red;">Error en la conexi√≥n con la API</span>`;
      }
    });
  </script>
  <script>
  // Base de im√°genes (carpeta en /static/img/)
  const BASE_IMG = "{{ url_for('static', filename='img/') }}";

  // Mapeo expl√≠cito municipio -> nombre de archivo (sin tildes/espacios)
  const imagenesMunicipio = {
    "CAQUET√Å": "caqueta.png",
    "FLORENCIA": "florencia.png",
    "SAN VICENTE DEL CAGUAN": "san_vicente_del_caguan.png",
    "CARTAGENA DELCHAIRA": "cartagena_delchaira.png",
    "EL PAUJIL": "el_paujil.png",
    "SOLANO": "solano.png",
    "CURILLO": "curillo.png",
    "PUERTO RICO": "puerto_rico.png",
    "SAN JOSE DEL FRAGUA": "san_jose_del_fragua.png",
    "MORELIA": "morelia.png",
    "SOLITA": "solita.png",
    "BELEN DE LOS ANDAQUIES": "belen_de_los_andaquies.png",
    "LA MONTANITA": "la_montanita.png",
    "EL DONCELLO": "el_doncello.png",
    "ALBANIA": "albania.png",
    "VALPARAISO": "valparaiso.png",
    "MILAN": "milan.png"
  };

  function actualizarImagenMunicipio(valorMunicipio) {
    const img = document.getElementById("mapaMunicipio");
    const lbl = document.getElementById("municipioLabel");
    const archivo = imagenesMunicipio[valorMunicipio] || "default.png";

    img.src = BASE_IMG + archivo;
    lbl.textContent = valorMunicipio ? valorMunicipio : "Seleccione un municipio";
  }

  // Cambia la imagen cuando el usuario elige un municipio
  document.getElementById("municipio").addEventListener("change", function() {
    actualizarImagenMunicipio(this.value);
  });

  // Opcional: inicializa cuando carga la p√°gina si ya hay un valor seleccionado
  window.addEventListener("DOMContentLoaded", () => {
    const inicial = document.getElementById("municipio").value;
    if (inicial) actualizarImagenMunicipio(inicial);
  });
</script>

</body>
</html>